(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.heatmap=factory()})(this,function(){"use strict";var f=function(){};var CONSTANT={THROTTLE_TIME:14,HM_NODE_WEIGHT_MAX:255,HM_NODE_WEIGHT_MIN:0,HM_NODE_HEIGHT_MIN:1,HM_NODE_ALPHA_MAX:1,HM_NODE_ALPHA_MIN:.01,HM_USER_SELECT:"hm-user-select",HM_OUTER_CONTAINER:"hm-outer-container",HM_CONTAINER:"hm-container",HM_ANIMATE:"hm-animate",HM_CANVAS:"hm-canvas",HM_MINI_CONTAINER:"hm-mini-container",HM_MINI_SLIDER:"hm-mini-slider",HM_MINI_MASK:"hm-mini-mask",HM_MINI_MASK_TOP:"hm-mini-mask-top",HM_MINI_MASK_RIGHT:"hm-mini-mask-right",HM_MINI_MASK_BOTTOM:"hm-mini-mask-bottom",HM_MINI_MASK_LEFT:"hm-mini-mask-left",HM_MINI_CANVAS:"hm-mini-canvas",HM_ID:"data-hm-id",HM_PAGE:"data-hm-page"};var globalConfig={maxWidth:0,maxHeight:0,container:null,outerContainer:null,scale:1,radius:40,height:40,nodeBlur:.15,gradient:{.25:"rgb(0, 0, 255)",.55:"rgb(0, 255, 0)",.85:"rgb(255, 255, 0)",1:"rgb(255, 0, 0)"},pagination:{currentPage:1,pageSize:1e4},mini:{enabled:false,sliderMinHeight:30,sliderPaddingTop:2,sliderPaddingBottom:2,el:"",onDragStart:f,onDrag:f,onDragEnd:f,onClick:f},onScroll:f};var cache={init:function(){if(!this.arr)this.arr=[]},get:function(idx){return this.arr[idx-1]},set:function(obj){this.arr.push(obj);return obj},remove:function(dk){this.arr.forEach(function(obj,i,arr){dk===obj&&arr.splice(i,1)})},index:function(){return this.arr.length+1},list:function(){return this.arr}};var utils={extend:function(mod,opt){if(!opt)return mod;var conf={};for(var k in mod){if(typeof opt[k]==="object")conf[k]=this.extend(mod[k],opt[k]);else conf[k]=typeof opt[k]!=="undefined"?opt[k]:mod[k]}return conf},clone:function(o2){var o1={};for(var k in o2)o1[k]=o2[k];return o1},throttle:function(now){var time=(new Date).getTime();this.throttle=function(now){if(now-time>CONSTANT.THROTTLE_TIME){time=now;return true}return false};this.throttle(now)},getComputedWH:function(dom){var computed=getComputedStyle(dom);return{width:computed.width.replace(/px/,"")*1,height:computed.height.replace(/px/,"")*1}},getNodeHeight:function(height){if(height>this.opt.maxHeight)return this.opt.maxHeight;if(height<CONSTANT.HM_NODE_HEIGHT_MIN)return CONSTANT.HM_NODE_HEIGHT_MIN;return height},getNodeWeight:function(weight){if(weight>CONSTANT.HM_NODE_WEIGHT_MAX)return CONSTANT.HM_NODE_WEIGHT_MAX;if(weight<CONSTANT.HM_NODE_WEIGHT_MIN)return CONSTANT.HM_NODE_WEIGHT_MIN;return weight},getNodeAlpha:function(weight){var alpha=weight/CONSTANT.HM_NODE_WEIGHT_MAX;if(alpha>CONSTANT.HM_NODE_ALPHA_MAX)return CONSTANT.HM_NODE_ALPHA_MAX;if(alpha<CONSTANT.HM_NODE_ALPHA_MIN)return CONSTANT.HM_NODE_ALPHA_MIN;return alpha}};var view={getColorPalette:function(){var gradientConfig=this.opt.gradient||globalConfig.gradient;var paletteCanvas=document.createElement("canvas");var paletteCtx=paletteCanvas.getContext("2d");paletteCanvas.width=256;paletteCanvas.height=1;var gradient=paletteCtx.createLinearGradient(0,0,256,1);for(var key in gradientConfig){gradient.addColorStop(key,gradientConfig[key])}paletteCtx.fillStyle=gradient;paletteCtx.fillRect(0,0,256,1);return paletteCtx.getImageData(0,0,256,1).data},getNodeTemplate:function(radius,blurFactor){var tplCanvas=document.createElement("canvas");var tplCtx=tplCanvas.getContext("2d");var x=radius;var y=radius;tplCanvas.width=tplCanvas.height=radius*2;if(blurFactor==1){tplCtx.beginPath();tplCtx.arc(x,y,radius,0,2*Math.PI,false);tplCtx.fillStyle="rgba(0,0,0,1)";tplCtx.fill()}else{var gradient=tplCtx.createRadialGradient(x,y,radius*blurFactor,x,y,radius);gradient.addColorStop(0,"rgba(0,0,0,1)");gradient.addColorStop(1,"rgba(0,0,0,0)");tplCtx.fillStyle=gradient;tplCtx.fillRect(0,0,2*radius,2*radius)}return tplCanvas},getAttentionTemplate:function(width,height){var tplCanvas=document.createElement("canvas");var tplCtx=tplCanvas.getContext("2d");tplCanvas.width=width;tplCanvas.height=height;var midW=Math.round(width/2),midH=Math.round(height/2);var gradient1=tplCtx.createLinearGradient(midW,midH,midW,0);gradient1.addColorStop(0,"rgba(0,0,0,1)");gradient1.addColorStop(1,"rgba(0,0,0,0)");tplCtx.fillStyle=gradient1;tplCtx.fillRect(0,0,width,midH);var gradient2=tplCtx.createLinearGradient(midW,midH,midW,height);gradient2.addColorStop(0,"rgba(0,0,0,1)");gradient2.addColorStop(1,"rgba(0,0,0,0)");tplCtx.fillStyle=gradient2;tplCtx.fillRect(0,midH,width,midH);return tplCanvas},colorize:function(ctx){var colorPalette=this.colorPalette;var img=this.shadowCtx.getImageData(0,0,this.shadowCanvas.width,this.shadowCanvas.height);var imgData=img.data;var len=imgData.length;for(var i=3;i<len;i+=4){var alpha=imgData[i];var offset=alpha*4;if(offset){imgData[i-3]=colorPalette[offset];imgData[i-2]=colorPalette[offset+1];imgData[i-1]=colorPalette[offset+2];imgData[i]=alpha}}ctx.putImageData(img,0,0)},clear:function(){this.shadowCtx.clearRect(0,0,this.shadowCanvas.width,this.shadowCanvas.height);this.splitScreen.forEach(function(v){v.ctx.clearRect(0,0,v.canvas.width,v.canvas.height)})},renderBatch:function(){var self=this;this.splitScreen.forEach(function(v,i){var dataLimit=self.getDataLimit(i+1,self.opt.pagination.pageSize);view.render.call(self,dataLimit.nodes,dataLimit.attention,v.ctx)})},render:function(nodes,attention,ctx){var tpl,self=this,shadowCanvas=this.shadowCanvas,shadowCtx=this.shadowCtx,nodeBlur=this.opt.nodeBlur;nodes=nodes||this.data.nodes;attention=attention||this.data.attention;shadowCtx.clearRect(0,0,shadowCanvas.width,shadowCanvas.height);shadowCtx.globalAlpha=1;if(Array.isArray(nodes)&&nodes.length>0){nodes.forEach(function(node){if(!self._templates[node.radius]){self._templates[node.radius]=tpl=view.getNodeTemplate(node.radius,nodeBlur)}else{tpl=self._templates[node.radius]}shadowCtx.globalAlpha=node.alpha;shadowCtx.drawImage(tpl,node.x-node.radius,node.y-node.radius)});view.colorize.call(this,ctx)}if(Array.isArray(attention)&&attention.length>0){attention.forEach(function(node){if(!self._attentionTemplates[node.height]){self._attentionTemplates[node.height]=tpl=view.getAttentionTemplate(self.opt.maxWidth,node.height)}else{tpl=self._attentionTemplates[node.height]}shadowCtx.globalAlpha=node.alpha;shadowCtx.drawImage(tpl,0,node.y)});view.colorize.call(this,ctx)}},init:function(){this.shadowCanvas=document.createElement("canvas");this.shadowCtx=this.shadowCanvas.getContext("2d");this.colorPalette=view.getColorPalette.call(this);this._templates={};this._attentionTemplates={};this.container.classList.add(CONSTANT.HM_CONTAINER);var opt=this.opt,pagination=opt.pagination,shadowCanvas=this.shadowCanvas,computed=utils.getComputedWH(this.container);opt.maxWidth=shadowCanvas.width=computed.width;opt.maxHeight=opt.maxHeight<computed.height?computed.height:opt.maxHeight;var maxPageSize=shadowCanvas.height=opt.maxHeight;var canvas;if(pagination.currentPage*pagination.pageSize>maxPageSize){canvas=view.createCanvas.call(this,opt.maxWidth,maxPageSize,pagination.currentPage).canvas;this.container.appendChild(canvas)}else{var maxPage=Math.floor(maxPageSize%pagination.pageSize===0?maxPageSize/pagination.pageSize:maxPageSize/pagination.pageSize+1);while(pagination.currentPage<=maxPage){var pageSize=pagination.currentPage===maxPage?maxPageSize-(pagination.currentPage-1)*pagination.pageSize:pagination.pageSize;canvas=view.createCanvas.call(this,opt.maxWidth,pageSize,pagination.currentPage).canvas;this.container.appendChild(canvas);pagination.currentPage++}}},createCanvas:function(width,height,page){var splitScreen=this.splitScreen,canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;canvas.classList.add(CONSTANT.HM_CANVAS);canvas.setAttribute(CONSTANT.HM_PAGE,page);return splitScreen[splitScreen.length]={canvas:canvas,ctx:canvas.getContext("2d")}}};var thumbnail={init:function(){var mini=this.mini,index=this._number,miniOption=this.opt.mini;if(miniOption.enabled&&miniOption.el){var fragment=document.createDocumentFragment();mini.container=document.querySelector(miniOption.el);mini.canvas=document.createElement("canvas");mini.ctx=mini.canvas.getContext("2d");thumbnail.createSlider(mini,fragment,index);thumbnail.createMask(mini.mask,fragment);thumbnail.setContainerStyle(mini,index);thumbnail.setSliderHeight.call(this);mini.container.appendChild(fragment)}},createSlider:function(mini,fragment,index){var slider=mini.slider=document.createElement("div");slider.setAttribute(CONSTANT.HM_ID,index);slider.classList.add(CONSTANT.HM_MINI_SLIDER);fragment.appendChild(slider)},createMask:function(mask,fragment){var maskTop=mask.top=document.createElement("div"),maskRight=mask.right=document.createElement("div"),maskBottom=mask.bottom=document.createElement("div"),maskLeft=mask.left=document.createElement("div");maskTop.className=CONSTANT.HM_MINI_MASK+" "+CONSTANT.HM_MINI_MASK_TOP;maskRight.className=CONSTANT.HM_MINI_MASK+" "+CONSTANT.HM_MINI_MASK_RIGHT;maskBottom.className=CONSTANT.HM_MINI_MASK+" "+CONSTANT.HM_MINI_MASK_BOTTOM;maskLeft.className=CONSTANT.HM_MINI_MASK+" "+CONSTANT.HM_MINI_MASK_LEFT;fragment.appendChild(maskTop);fragment.appendChild(maskRight);fragment.appendChild(maskBottom);fragment.appendChild(maskLeft)},setContainerStyle:function(mini,index){var computed=utils.getComputedWH(mini.container);mini.canvas.width=computed.width;mini.canvas.height=computed.height;mini.canvas.classList.add(CONSTANT.HM_MINI_CANVAS);mini.container.classList.add(CONSTANT.HM_MINI_CONTAINER);mini.container.setAttribute(CONSTANT.HM_ID,index)},setSliderHeight:function(){var mini=this.mini,miniOption=this.opt.mini,sliderMinHeight=miniOption.sliderMinHeight,outerContainer=this.outerContainer,outerHeight=utils.getComputedWH(outerContainer).height;var height=outerHeight/this.opt.maxHeight*mini.canvas.height;if(height<sliderMinHeight){height=sliderMinHeight}thumbnail.move.call(this,{y:0,h:height})},move:function(coord){if(!this&&!this.mini)return;var y=coord.y=Math.ceil(coord.y),mini=this.mini,miniOption=this.opt.mini,maxHeight=mini.canvas.height;coord.h=coord.h||parseInt(mini.slider.style.height);if(coord.y+coord.h>=maxHeight){y=maxHeight-coord.h;coord.y=y-miniOption.sliderPaddingBottom}if(coord.y<=0){y=0;coord.y=miniOption.sliderPaddingTop}mini.slider.style.cssText="height:"+coord.h+"px;top:"+coord.y+"px";mini.mask.top.style.cssText="height:"+coord.y+"px";mini.mask.right.style.cssText="height:"+coord.h+"px;top:"+coord.y+"px";mini.mask.bottom.style.cssText="top:"+(coord.y+coord.h)+"px";mini.mask.left.style.cssText="height:"+coord.h+"px;top:"+coord.y+"px";return y},clear:function(){var mini=this.mini;mini.ctx.clearRect(0,0,mini.canvas.width,mini.canvas.height)},render:function(){var self=this,mini=this.mini,maxWidth=this.opt.maxWidth,maxHeight=this.opt.maxHeight;var position=0;this.splitScreen.forEach(function(v,i){if(v.canvas.height===maxHeight){mini.ctx.drawImage(v.canvas,0,position,maxWidth,maxHeight,0,0,mini.canvas.width,mini.canvas.height)}else{var height=v.canvas.height/maxHeight*mini.canvas.height;mini.ctx.drawImage(v.canvas,0,0,maxWidth,v.canvas.height,0,position,mini.canvas.width,height);position+=height}});mini.container.appendChild(mini.canvas)}};var handleEvent={init:function(isbind){if(this.isbind)return;this.isbind=isbind;this.globalUnbind();this.globalBind()},globalBind:function(){document.addEventListener("mousedown",this.mouseDown,false);document.addEventListener("mousemove",this.mouseMove,false);document.addEventListener("mouseup",this.mouseUp,false);document.addEventListener("click",this.click,false);this.isbind=true},globalUnbind:function(){document.removeEventListener("mousedown",this.mouseDown,false);document.removeEventListener("mousemove",this.mouseMove,false);document.removeEventListener("mouseup",this.mouseUp,false);document.removeEventListener("click",this.click,false);this.isbind=false},bind:function(){this.outerContainer.addEventListener("scroll",handleEvent.scroll,false)},unbind:function(){this.outerContainer.removeEventListener("scroll",handleEvent.scroll,false)},mouseDown:function(event){var target=event.target;if(target.classList.contains(CONSTANT.HM_MINI_SLIDER)){document.body.classList.add(CONSTANT.HM_USER_SELECT);handleEvent.isDrag=true;handleEvent.heatmap=cache.get(target.getAttribute(CONSTANT.HM_ID)*1);handleEvent.offsetX=event.offsetX||0;handleEvent.offsetY=event.offsetY||0;handleEvent.heatmap.opt.mini.onDragStart.call(handleEvent.heatmap,event)}},mouseMove:function(event){if(!handleEvent.isDrag)return;if(!utils.throttle((new Date).getTime()))return;handleEvent.linkage.call(handleEvent.heatmap,event.pageY,handleEvent.offsetY);handleEvent.heatmap.opt.mini.onDrag.call(handleEvent.heatmap,event)},mouseUp:function(event){if(handleEvent.isDrag){document.body.classList.remove(CONSTANT.HM_USER_SELECT);handleEvent.heatmap.opt.mini.onDragEnd.call(handleEvent.heatmap,event)}delete handleEvent.heatmap;delete handleEvent.isDrag;delete handleEvent.offsetX;delete handleEvent.offsetY},click:function(event){var target=event.target;if(target.classList.contains(CONSTANT.HM_MINI_SLIDER))return;var miniContainer=handleEvent.searchUp(target,CONSTANT.HM_MINI_CONTAINER);if(miniContainer){miniContainer.classList.add(CONSTANT.HM_ANIMATE);var heatmap=cache.get(miniContainer.getAttribute(CONSTANT.HM_ID)*1);handleEvent.linkage.call(heatmap,event.pageY);heatmap.opt.mini.onClick.call(heatmap,event);setTimeout(function(){miniContainer.classList.remove(CONSTANT.HM_ANIMATE)},100)}},wheel:function(event){var outerContainer=handleEvent.searchUp(event.target,CONSTANT.HM_OUTER_CONTAINER);if(outerContainer){var heatmap=cache.get(outerContainer.getAttribute(CONSTANT.HM_ID)*1);heatmap.moveSlider(outerContainer.scrollTop)}},scroll:function(event){var heatmap=cache.get(event.currentTarget.getAttribute(CONSTANT.HM_ID)*1);if(heatmap){if(heatmap.opt.mini.enabled){var scrollTop=event.currentTarget.scrollTop;heatmap.moveSlider(scrollTop)}heatmap.opt.onScroll.call(heatmap,event)}},searchUp:function(node,className){if(!node||node===document.body||node===document)return undefined;if(node.classList.contains(className))return node;return this.searchUp(node.parentNode,className)},linkage:function(pageY,offsetY){var mini=this.mini;var offset=mini.container.getBoundingClientRect();offsetY=offsetY||parseInt(mini.slider.style.height)/2;var y=thumbnail.move.call(this,{y:pageY-offsetY-offset.top});var scale=y/mini.canvas.height;this.outerContainer.scrollTop=scale*this.opt.maxHeight}};function HeatMap(options,originData,index){var container=document.querySelector(options.container);var outerContainer=document.querySelector(options.outerContainer);if(!options.container||!options.outerContainer||!container||!outerContainer){throw new Error("Invalid HeatMap Container Selector")}container.setAttribute(CONSTANT.HM_ID,index);outerContainer.setAttribute(CONSTANT.HM_ID,index);this.container=container;this.outerContainer=outerContainer;handleEvent.unbind.call(this);handleEvent.bind.call(this);this.init(options,originData,index)}HeatMap.prototype={constructor:HeatMap,init:function(options,originData,index){this._number=index;this.opt=utils.extend(globalConfig,options);this.splitScreen=[];this.data=this.setData(originData);view.init.call(this);this.draw();if(this.opt.mini.enabled){this.mini={ctx:null,canvas:null,container:null,slider:null,mask:{top:null,right:null,bottom:null,left:null}};thumbnail.init.call(this);this.drawMini()}},destroy:function(){handleEvent.unbind.call(this);delete this.opt;delete this.data;delete this._number;delete this.container;delete this.originData;delete this.outerContainer;delete this.splitScreen;delete this.shadowCanvas;delete this.shadowCtx;delete this.colorPalette;delete this._templates;delete this._attentionTemplates;delete this.mini},setData:function(originData){var self=this,opt=this.opt,data={nodes:[],attention:[]};if(!originData)return data;this.originData=originData;if(Array.isArray(originData.nodes)){originData.nodes.forEach(function(node){var n={x:node.x,y:node.y,weight:utils.getNodeWeight(node.weight),alpha:utils.getNodeAlpha(node.weight),radius:node.radius};data.nodes.push(n);if(opt.maxHeight<n.y+n.radius)opt.maxHeight=n.y+n.radius})}if(Array.isArray(originData.attention)){originData.attention.forEach(function(node){var n={y:node.y,height:utils.getNodeHeight.call(self,node.height),weight:utils.getNodeWeight(node.weight),alpha:utils.getNodeAlpha(node.weight)};data.attention.push(n);if(opt.maxHeight<n.y+n.height)opt.maxHeight=n.y+n.height})}return data},getDataLimit:function(current,pageSize){var limit={nodes:[],attention:[]},max=current*pageSize,min=max-pageSize,data=this.data;data.nodes.forEach(function(node){if((min<=node.y||min<=node.y+node.radius)&&(node.y<=max||node.y-node.radius<=max)){var n=utils.clone(node);n.y-=min;limit.nodes.push(n)}});data.attention.forEach(function(node){if((min<=node.y||min<=node.y+node.height/2)&&(node.y<=max||node.y-node.height/2<=max)){var n=utils.clone(node);n.y-=min;limit.attention.push(n)}});return limit},load:function(data){this.setData(data);this.draw();this.opt.mini.enabled&&this.drawMini()},clear:function(){view.clear.call(this)},draw:function(){this.clear();view.renderBatch.call(this)},clearMini:function(){thumbnail.clear.call(this)},drawMini:function(){this.clearMini();thumbnail.render.call(this)},moveSlider:function(scrollTop){if(!this.opt.mini.enabled)return;var scale=scrollTop/this.opt.maxHeight;var y=scale*this.mini.canvas.height;thumbnail.move.call(this,{y:y})}};var heatmap={version:"1.0.4",instance:function(options,originData){handleEvent.init(true,document.body);cache.init();return cache.set(new HeatMap(options,originData,cache.index()))},destroy:function(obj){if(obj){obj.container.removeAttribute(CONSTANT.HM_ID);cache.remove(obj);obj.destroy();obj=null}cache.arr==0&&handleEvent.globalUnbind()}};return heatmap});